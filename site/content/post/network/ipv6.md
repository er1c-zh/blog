---
title: "IPv6"
date: 2023-07-17T20:19:47+08:00
draft: true
tag:
    - network
    - what
    - how
---

关于什么是 IPv6 和如何使用 IPv6 。

<!--more-->

# 主要特性

IPv6 是一个用于网络内包交换和跨 IP 网络点到点数据报传输能力的网络层协议，
几乎遵循 IPv4 中的设计原则。

在更大的地址空间之外，
IPv6 也实现了 IPv4 没有的特性：

- address configuration
- network renumbering
- 切换网络连接提供者时的路由声明

IPv6 通过把分割包的工作分配给终端，简化了路由器处理包的过程。

IPv6 子网的大小被固定为 64 bit 的主机标识符部分限制。

IPv6 支持三种传输模式： unicast anycast multicast 。

# IPv6 地址结构

[RFC 4291 IP Version 6 Adderssing Architecture](https://datatracker.ietf.org/doc/html/rfc4291)

128 位的、分配给一个或一组接口的标识符。

有三种类型的地址：

- unicast 指向一个接口的标识符。
- anycast 指向（通常不在一个主机上的）一组接口。投递给 anycast 类型的地址意味着只需要投递给其中的一个节点。 （路由协议中的距离最近）
- multicast 指向一组接口。 发送给该类型的地址的包需要发送给集合中的所有接口。

## 地址模型 Addressing Model

IPv6 地址分配的对象是接口。

所有的接口都被要求有至少一个本地单播地址 ( Link-Local unicast address ) 。

一个接口可以有多个不同的地址。

如果多个物理接口在网络层被视作一个接口，
一个地址也可以分配给多个物理接口。
这个特性可以用作负载均衡。

## 文本表示

三种格式：

- 最好 (prefered) 的格式是：8 个 4 位 16 进制数字，由冒号链接。 `ABCD:EF01:2345:6789:ABCD:EF01:2345:6789`
- 一些情况下可以省略 0
    - 前导零
    - 多个连续的部分为0，可以用 `::` 代替。 

        `FF01:0:0:0:0:0:0:101` -> `FF01::101`
- 一种可选的格式是 `x:x:x:x:x:x:d.d.d.d` 。方便用于混用 IPv4 IPv6 的情况。

    如 `0:0:0:0:0:FFFF:129.144.52.38`

和 IPv4 类似的格式来表示地址前缀的长度：

`ipv6-address/prefix-length`

## 地址类型及区分

| Address type        | Binary prefix       | IPv6 notation |
| ------------        | -------------       | ------------- |
| 未定义               | 00...0  (128 bits)  | ::/128        |
| 本地回环              | 00...1  (128 bits)  | ::1/128       |
| 多播                 | 11111111            | FF00::/8      |
| 本地单播             | 1111111010          | FE80::/10     |
| 全域单播             | (everything else)   | *             |

anycast 使用单播的地址空间，语法上与单播无法区分。

## 单播地址

IPV6 的单播地址通过任意长度的前缀聚合在一起。

IPv6 有若干类型的单播地址：

- 全局单播地址
- 本地链接地址
- 特殊用途的全局单播地址，如： 嵌在 IPv6 中的 IPv4 地址。

### 接口标识符 和 EUI-64 Extended Unique Identifier

IPv6 地址中的接口标识符用与标记一个链接中的接口。
在一个子网前缀下，接口标识符需要保持唯一。

某些情况下，接口标识符通过链路层地址直接生成。
（因此）相同的接口标识符在接入不同的子网的情况下可能被用于同一个节点上的多个接口。

接口标识符的唯一性和 IPv6 地址的唯一性是不同的概念。

对于所有的单播地址，
除了开头是 000 的情况，
接口标识符都需要是 64 位长并按照修 **修改过的 EUI-64 地址** *( Modified EUI-64 format )* 构建。
**修改过的** 指的是，将符合 IEEE EUI-64 模式的标识符的 **全局/本地位** 反转。
因此，全局/本地位为 1 时表示全局，反之表示本地。
这么设计的目的是便于网络管理员处理硬件标识符不可用时非全局标识符的配置。

> 通常来说，一种生成方法是节点利用 48 位的 MAC 地址给自己生成 IPv6 地址。
> 具体的，将 MAC 地址分割为前后 24 位两个部分，中间插入 `FFFE` 拼接成 64 位。
> 然后，将 `universal/local 位` 反转而成。

IPv6 节点不需要验证标记为全局的接口标识符是否唯一。

### 未定义地址 Unspecified Address

地址 `::` 被称作未定义地址。
它不可用于任何节点。
它表示地址的缺失。

一个可能的应用是，
一个节点在得知自身的地址前发送的 IPv6 包的源地址字段。

### 本地回环地址

`::1` 是本地回环地址，用于发送给自身的包。

### 全局单播地址

全局单播地址的常见格式如下：

- 前 n 位表示全局路由前缀，通常是层级化结构的，被授予给一个 site 。
- 中间 m 位表示子网 ID。
- 剩下的是接口标识符，在前文已经提到。

除了开头为 `000` 的 IPv6 地址，
其他的地址都拥有 64 位长的接口标识符。

开头为 `000` 的地址的一个例子是嵌入在 IPv6 的 IPv4 地址。

### 嵌入了 IPv4 地址的 IPv6 地址

IPv6 地址有两种格式携带 IPv4 地址：

- 兼容 IPv4 的IPv6 地址：用于迁移到 IPv6 ，尾 32 位填充 IPv4 地址，其他位填0
- IPv4-Mapped IPv6 Address

### 本地链接单播地址

本地链接地址用于诸如
自动地址配置、邻居发现或路由器缺失的场景。

路由器 **MUST NOT** 转发源地址或目的地址是本地链接地址的包到其他连接上。

## Anycast Address

# Reference

- [RFC 4291 IP Version 6 Adderssing Architecture](https://datatracker.ietf.org/doc/html/rfc4291)
