---
title: "IPv6"
date: 2023-07-17T20:19:47+08:00
draft: false
tag:
    - network
    - what
    - how
---

关于什么是 IPv6 和如何使用 IPv6 。

*（用来弄清楚如何配置路由器相关配置。）*

<!--more-->

# 主要特性

IPv6 是一个用于网络内包交换和跨 IP 网络点到点数据报传输能力的网络层协议，
几乎遵循 IPv4 中的设计原则。

在更大的地址空间之外，
IPv6 也实现了 IPv4 没有的特性：

- address configuration
- network renumbering
- 切换网络连接提供者时的路由声明

IPv6 通过把分割包的工作分配给终端，简化了路由器处理包的过程。

IPv6 子网的大小被固定为 64 bit 的主机标识符部分限制。

IPv6 支持三种传输模式： unicast anycast multicast 。

# IPv6 地址结构

[RFC 4291 IP Version 6 Adderssing Architecture](https://datatracker.ietf.org/doc/html/rfc4291)

128 位的、分配给一个或一组接口的标识符。

有三种类型的地址：

- unicast 指向一个接口的标识符。
- anycast 指向（通常不在一个主机上的）一组接口。投递给 anycast 类型的地址意味着只需要投递给其中的一个节点。 （路由协议中的距离最近）
- multicast 指向一组接口。 发送给该类型的地址的包需要发送给集合中的所有接口。

## 地址模型 Addressing Model

IPv6 地址分配的对象是接口。

所有的接口都被要求有至少一个本地单播地址 ( Link-Local unicast address ) 。

一个接口可以有多个不同的地址。

如果多个物理接口在网络层被视作一个接口，
一个地址也可以分配给多个物理接口。
这个特性可以用作负载均衡。

## 文本表示

三种格式：

- 最好 (prefered) 的格式是：8 个 4 位 16 进制数字，由冒号链接。 `ABCD:EF01:2345:6789:ABCD:EF01:2345:6789`
- 一些情况下可以省略 0
    - 前导零
    - 多个连续的部分为0，可以用 `::` 代替。 

        `FF01:0:0:0:0:0:0:101` -> `FF01::101`
- 一种可选的格式是 `x:x:x:x:x:x:d.d.d.d` 。方便用于混用 IPv4 IPv6 的情况。

    如 `0:0:0:0:0:FFFF:129.144.52.38`

和 IPv4 类似的格式来表示地址前缀的长度：

`ipv6-address/prefix-length`

## 地址类型及区分

| Address type        | Binary prefix       | IPv6 notation |
| ------------        | -------------       | ------------- |
| 未定义              | 00...0  (128 bits)  | ::/128        |
| 本地回环            | 00...1  (128 bits)  | ::1/128       |
| 多播                | 1111 1111           | FF00::/8      |
| 本地单播            | 1111 1110 10        | FE80::/10     |
| 全域单播            | (everything else)   | *             |

anycast 使用单播的地址空间，语法上与单播无法区分。

## 单播地址

IPV6 的单播地址通过任意长度的前缀聚合在一起。

IPv6 有若干类型的单播地址：

- 全局单播地址
- 本地链接地址
- 特殊用途的全局单播地址，如： 嵌在 IPv6 中的 IPv4 地址。

### 接口标识符 和 EUI-64 Extended Unique Identifier

IPv6 地址中的接口标识符用与标记一个链接中的接口。
在一个子网前缀下，接口标识符需要保持唯一。

某些情况下，接口标识符通过链路层地址直接生成。
（因此）相同的接口标识符在接入不同的子网的情况下可能被用于同一个节点上的多个接口。

接口标识符的唯一性和 IPv6 地址的唯一性是不同的概念。

对于所有的单播地址，
除了开头是 000 的情况，
接口标识符都需要是 64 位长并按照修 **修改过的 EUI-64 地址** *( Modified EUI-64 format )* 构建。
**修改过的** 指的是，将符合 IEEE EUI-64 模式的标识符的 **全局/本地位** 反转。
因此，全局/本地位为 1 时表示全局，反之表示本地。
这么设计的目的是便于网络管理员处理硬件标识符不可用时非全局标识符的配置。

> 通常来说，一种生成方法是节点利用 48 位的 MAC 地址给自己生成 IPv6 地址。
> 具体的，将 MAC 地址分割为前后 24 位两个部分，中间插入 `FFFE` 拼接成 64 位。
> 然后，将 `universal/local 位` 反转而成。

IPv6 节点不需要验证标记为全局的接口标识符是否唯一。

### 未定义地址 Unspecified Address

地址 `::` 被称作未定义地址。
它不可用于任何节点。
它表示地址的缺失。

一个可能的应用是，
一个节点在得知自身的地址前发送的 IPv6 包的源地址字段。

### 本地回环地址

`::1` 是本地回环地址，用于发送给自身的包。

### 全局单播地址

全局单播地址的常见格式如下：

- 前 n 位表示全局路由前缀，通常是层级化结构的，被授予给一个 site 。
- 中间 m 位表示子网 ID。
- 剩下的是接口标识符，在前文已经提到。

除了开头为 `000` 的 IPv6 地址，
其他的地址都拥有 64 位长的接口标识符。

开头为 `000` 的地址的一个例子是嵌入在 IPv6 的 IPv4 地址。

### 嵌入了 IPv4 地址的 IPv6 地址

IPv6 地址有两种格式携带 IPv4 地址：

- 兼容 IPv4 的IPv6 地址：用于迁移到 IPv6 ，尾 32 位填充 IPv4 地址，其他位填0
- IPv4-Mapped IPv6 Address

### 本地链接单播地址

本地链接地址用于诸如
自动地址配置、邻居发现或路由器缺失的场景。

路由器 **MUST NOT** 转发源地址或目的地址是本地链接地址的包到其他连接上。

## Anycast Address

Anycast Address 与单播地址无法从语法的角度区分，
当一个地址被分配给了多个接口，
这个地址就成为了一个 Anycast Address 。

一个节点如果被分配了 Anycast Address ，它一定需要知道自己被分配的是一个 Anycast Address 。

一个 Anycast Adderss 总是有一个前缀指向了包含了所有该地址定位的接口的区域。
在这个区域之外，所有该地址的路由可能会与该前缀聚合成一条；
在区域之内，该地址需要单独处理。

Anycast Address 的一种用途是标记一组路由属于某个提供互联网服务的组织。
另一个可能的用途是标记一组路由链接到了一个特定的子网或者提供了一个特定路由域 *( routing domain )* 的入口。

## 多播地址

多播地址是用于表示一组（通常分布在不同节点上的）接口的标识符。

# 与 IPv4 对比、动机与起源

因为 IPv4 地址空间不能满足日益增长的需要，所以引入了地址空间更大的 IPv6 。

除了更大的地址空间， IPv6 还有一些不同：

- IPv6 默认支持多播。
- 无状态地址自动配置技术 (Stateless address autoconfiguration, SLAAC)

    IPv6 主机自动配置地址。
    每个接口拥有一个自生成的本地连接的地址。
    除此之外，当设备联入互联网时，会进行冲突解决，路由器也会通过 router advertisement 提供地址前缀。
    除此之外，还可以通过 DHCPv6 进行有状态的地址分配和手动分配静态地址。

- IPsec
- 简化路由器处理

    只保留包头中的必要的字段，特别的，去掉了转发的校验和机制。

- 移动性：能够提供比 IPv4 更好地移动性， 允许整个子网在不 renumber 的情况下移动到另一个路由下。
- 支持扩展包的 Header

# SLAAC & DHCPv6

## SLAAC

系统启动时，每个节点会为每个启用 IPv6 的接口自动生成一个本地链接的地址。
就算 **全局地址** *( globally routable address )* 已经手动设置或者
被通过 “设置协议” 获得（，也会生成这个本地链接地址）。

这项工作通过 SLAAC 完成，不需要提前设置，
使用了 **邻居发现协议** *( Neighbor Discovery Protocol )* 的一部分实现。

主机向路由器发送一个“请求地址前缀的包”，
IPv6 路由器会返回一个前缀作为响应。

地址的低 64 位由接口标识符构成，
出于隐私的原因，这个标识符应该是伪随机数。
之前的 Modified EUI-64 格式的标识符因此被废弃。
也是因为隐私的原因，
每次生成的标识符需要与任何该接口自动生成的标识符不一致。

### 重复地址检测

首先，节点为接口生成一个地址，
然后开始监听所有节点的广播地址，因为如果一个节点已经使用了该地址，
会在这个多播地址上发送 Neighbor Advertisement ( ICMPv6 Type 136 ) 包；
并且开始监听这个地址的多播地址，
用于处理其他节点也在尝试使用这个地址的情况。

以上的操作完成后，
向这个地址发送 Neighbor Solicitation ( ICMPv6 Type 135) 包。
如果没有冲突，这个地址就可以被使用。

### 地址生命周期

除非特别设置，地址的生命周期默认是无限期的。

一个地址的状态由两个生命周期决定：优先生命周期 ( preferred lifetime ) 和生效生命周期。

当一个地址的优先生命周期结束时，
这个地址的状态变更为 **废弃的** ，之后不应在这个地址上建立新的链接 ；
当生效生命周期过期时，地址的状态变更变更为 **不可用** ，
这个地址从当前的接口移除。

## DHCPv6

DHCPv6 是一个客户端/服务器协议，
用来为设备提供配置能力。
最基本的协议能力为与服务器链接在一个网络中的客户端提供配置能力。
可以通过中转代理为不是链接在同一网络的设备提供服务。

DHCPv6 用于为 IPv6 主机配置地址、地址前缀、默认路由、本地段 MTU 、以及其他运转 IPv6 协议所需要的数据。

DHCPv6 的信息交换通过 UDP 完成。
客户端将信息发送到一个保留的、本地链接多播地址上，
因此不需要配置客户端的 DHCPv6 服务端地址。
如果需要发送到非本地链接的 DHCPv6 服务端上，
需要一个在本地链接上的 DHCP 中转代理 *( DHCP relay agent )* 来完成中转。

### 四步交互法

为了分配一个或多个地址、和（或）协调前缀，
客户端首先确定 DHCP 服务端，然后请求分配地址、协商地址前缀和其他配置信息。

1. 客户端向 All_DHCP_Relay_Agents_and_Servers 多播地址发送 Solicit 请求寻找可用的 DHCP 服务器。
1. 任何符合要求的服务端响应 Advertise 消息。
1. 客户端挑选一个服务端，发送 Request 消息来确认分配地址、协商地址前缀以及其他配置信息。
1. 服务端返回包含地址、地址前缀、配置的 Reply 消息。

除此之外，也有适用于特殊场景的两步交互法。

# Reference

- [IPv6 wiki](https://en.wikipedia.org/wiki/IPv6)
- [IPv6 Address wiki](https://en.wikipedia.org/wiki/IPv6_address)
- [RFC 4291 IP Version 6 Adderssing Architecture](https://datatracker.ietf.org/doc/html/rfc4291)
- [RPC 4862 IPv6 Stateless Address Autoconfiguration](https://datatracker.ietf.org/doc/html/rfc4862)
- [DHCPv6 wiki](https://en.wikipedia.org/wiki/DHCPv6)
- [RFC 8415 DHCPv6](https://datatracker.ietf.org/doc/html/rfc8415)
