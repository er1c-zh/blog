---
title: "MySQLå„ç§æƒ…å†µçš„åŠ é”åˆ†æ"
date: 2020-10-27T02:46:48+08:00
draft: false
tags:
    - MySQL
---

é¦–å…ˆä»‹ç»äº†äº‹åŠ¡ä¸éš”ç¦»çº§åˆ«ï¼Œå¼•å…¥äº†åŠ é”çš„å¤æ‚æ€§ä»¥åŠInnoDBçš„é”ç±»å‹ã€‚æœ€åå¯¹äºå„ç§ç´¢å¼•ã€æ•°æ®çš„åŠ é”æƒ…å†µè¿›è¡Œäº†ç›¸åº”çš„åˆ†æã€‚

# åŠ é”æ˜¯ä¸ºäº†æ•°æ®åº“èƒ½å¤Ÿåœ¨å¹¶å‘ä¸‹æ­£ç¡®è¿è¡Œ

MySQLæ˜¯ä¸€ä¸ªæ”¯æŒ**äº‹åŠ¡**çš„æ•°æ®åº“ã€‚å¦‚ä½•å¤„ç†å¤šä¸ªäº‹åŠ¡ä¹‹é—´çš„å…³ç³»ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼š**éš”ç¦»çº§åˆ«**ã€‚

## å››ä¸ªéš”ç¦»çº§åˆ«

*æ³¨æ„ï¼Œä¸åŒæ•°æ®åº“å¯¹äºäº‹åŠ¡çš„éš”ç¦»çº§åˆ«å®ç°ç•¥æœ‰ä¸åŒã€‚*

### READ UNCOMMITED ï¼ˆå¯èƒ½ï¼‰è¯»åˆ°æœªæäº¤çš„äº‹åŠ¡

å­˜åœ¨çš„é—®é¢˜ï¼š**è„è¯»**

ä¸€ä¸ªäº‹åŠ¡å¯èƒ½è¯»å–åˆ°å¦ä¸€ä¸ªäº‹åŠ¡ä½œå‡ºçš„ã€**æœªæäº¤**çš„ä¿®æ”¹ã€‚

å®é™…ç”Ÿäº§ä¸­ï¼Œè¿™ç§éš”ç¦»çº§åˆ«é€šå¸¸æ²¡ä»€ä¹ˆä½¿ç”¨åœºæ™¯ã€‚

### READ COMMITTED åªèƒ½è¯»åˆ°å·²ç»æäº¤çš„äº‹åŠ¡

ä¸ºäº†è§£å†³è„è¯»ï¼Œè¯¥éš”ç¦»çº§åˆ«é™åˆ¶ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä»»æ„ä¿®æ”¹ï¼Œåœ¨æäº¤ä¹‹å‰ï¼Œéƒ½ä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡è¯»å–åˆ°ã€‚

å­˜åœ¨çš„é—®é¢˜ï¼š**ä¸å¯é‡å¤è¯»**

è€ƒè™‘ä¸€ç§æƒ…æ™¯ï¼š

1. äº‹åŠ¡Aé¦–å…ˆè¯»å–æ•°æ®xå€¼è®°ä¸ºx1
1. äº‹åŠ¡Bä¿®æ”¹xä¸ºx2å¹¶æäº¤
1. æ­¤æ—¶äº‹åŠ¡Aå†æ¬¡è¯»å–xè·å¾—x2ä¸x1ä¸åŒ

è¿™ç§æƒ…å†µç§°ä¸º**ä¸å¯é‡å¤è¯»**ã€‚

### REPEATABLE READ å¯é‡å¤è¯» **MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«**

é€šå¸¸å¯é‡å¤è¯»è§£å†³äº†ä¸å¯é‡å¤è¯»é—®é¢˜ã€‚

å­˜åœ¨çš„é—®é¢˜ï¼š**å¹»è¯»**

ç±»ä¼¼ä¸å¯é‡å¤è¯»çš„å½¢æˆåŸå› ï¼Œå°†ç‰¹å®šçš„æ•°æ®çš„æŸ¥è¯¢ï¼Œæ”¹æˆèŒƒå›´æŸ¥è¯¢ã€‚

äº‹åŠ¡Båˆ›å»ºä¸€æ¡æ–°çš„è®°å½•ï¼Œé‚£ä¹ˆäº‹åŠ¡Aç¬¬äºŒæ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰ä¸€æ¡æ–°çš„è®°å½•è¢«æŸ¥åˆ°ã€‚è¿™ç§ç°è±¡æˆä¸º**å¹»è¯»**ã€‚

### SERIALIZABLE ä¸²è¡ŒåŒ–

ä»¥ä¸Šçš„é—®é¢˜å‡ä¸ºå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯¼è‡´çš„ã€‚ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«å°†äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œè‡ªç„¶ä¸ä¼šäº§ç”Ÿé—®é¢˜ã€‚

# ä¸ºäº†æ›´é«˜çš„æ€§èƒ½ï¼Œé”çš„ç²’åº¦éœ€è¦å°½å¯èƒ½çš„å°

æ•°æ®çš„å®‰å…¨ã€å‡†ç¡®ä¸èƒ½æ‰¿è½½çš„å¹¶å‘é‡æ˜¯è··è··æ¿çš„ä¸¤ç«¯ã€‚

åœ¨èƒ½å¤Ÿæ»¡è¶³ä¸šåŠ¡å¯¹æ•°æ®å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œå‡å°‘é”çš„ç²’åº¦ï¼Œæ˜¯æé«˜æ€§èƒ½çš„æœ‰æ•ˆæ–¹æ³•ã€‚

# InnoDBçš„é”ç±»å‹

è¡Œé”ï¼Œæ„å‘é”(Intention Lock)ï¼Œè®°å½•é”ï¼ˆRecord Lockï¼‰ï¼Œé—´éš™é”ï¼ŒNext-keyé”ï¼Œæ’å…¥æ„å‘é”ï¼Œè‡ªå¢æ•°å€¼é”ã€‚

## è¡Œé”ï¼šå…±äº«é”ä¸æ’ä»–é”

InnoDBå®ç°äº†æ ‡å‡†çš„è¡Œé”ã€‚

å…¶ä¸­åŒ…å«äº†å…±äº«é”ä¸æ’ä»–é”ã€‚

## æ„å‘é”

æ„å‘é”æ˜¯ç”¨æ¥å…¼å®¹è¡¨é”ä¸è¡Œé”è€Œè®¾è®¡çš„ã€‚

æ„å‘é”æ˜¯ä¸€ä¸ªè¡¨é”ã€‚åˆ†ä¸ºè¯»å†™ä¸¤ç§ï¼ŒIXå’ŒISã€‚

æ„å‘é”æœ‰ä¸¤ä¸ªçº¦å®šï¼š

1. å¯¹äºå°è¯•ç”³è¯·è¡Œé”è¯»é”çš„äº‹åŠ¡ï¼Œå¿…é¡»å…ˆç”³è¯·åˆ°ISé”ã€‚æ’ä»–é”äº¦ç„¶ã€‚
1. æ„å‘é”ä¼šé˜»å¡è¯»å†™è¡¨é”ï¼Œå¦‚IXé˜»å¡è¯»è¡¨é”ï¼Œä¸ä¼šé˜»å¡è¯»è¡Œé”ã€‚

ä¸ä¸¥è°¨çš„è®²ï¼ŒæŒæœ‰ä¸€ä¸ªæ„å‘é”ï¼Œè¡¨æ˜è¯¥äº‹åŠ¡æŒæœ‰â€œéƒ¨åˆ†â€è¯¥ç§è¡¨é”ã€‚

## è®°å½•é”

è®°å½•é”æ˜¯åŠ åœ¨**ç´¢å¼•çš„å¯¹åº”æ¡ç›®**ä¸Šçš„ã€‚ç”¨äºå®ç°è¡Œé”ï¼Œå¦‚é¿å…å…¶ä»–äº‹åŠ¡ä¿®æ”¹å¯¹åº”æ¡ä»¶çš„è®°å½•ã€‚

æˆ‘è®¤ä¸ºè®°å½•é”å°±æ˜¯è¡Œé”çš„å®ç°ã€‚

## Gap Lock 

é—´éš™é”æ˜¯åŠ åœ¨**ç´¢å¼•çš„ä¸¤ä¸ªæ¡ç›®ä¹‹é—´æˆ–åˆ°æ­£/è´Ÿæ— ç©·**ä¸Šçš„é”ã€‚

ç”¨æ¥é¿å…å…¶ä»–äº‹åŠ¡å¯¹æœ¬äº‹åŠ¡ä¿®æ”¹çš„ï¼ˆæŒ‡å†™æ“ä½œï¼‰éœ€è¦åŠ é”çš„åŒºé—´çš„æ’å…¥ã€‚

```mysql
# idæ˜¯ä¸»é”®
# transaction A
begin
select * from t1 where id >= 10 and id <= 20 for upate # åœ¨idç´¢å¼•ä¸Šä¼šæœ‰10 - 20çš„ç´¢å¼•
### ä¸è¦æäº¤

# transaction B
insert into t1 values (`val`) (15) # ä¼šè¢«é˜»å¡
```

**å¦‚æœæŸ¥è¯¢çš„æ¡ä»¶æ²¡æœ‰åœ¨ç´¢å¼•ä¸Šå‘¢ï¼Ÿ**

(RRä¸‹)ä¼šé€€åŒ–é”ä½å…¨è¡¨çš„è¡Œã€‚*è¿™çœŸçš„ä¸æ˜¯æˆ‘è¯•éªŒå“ªé‡Œå‡ºé—®é¢˜äº†ğŸ‡ï¼Ÿ*

## Next-Key Lock

Next-Keyé”æ˜¯ä¸€ä¸ªè®°å½•é”å’Œé”å®šè¯¥è®°å½•å‰çš„é—´éš™çš„é—´éš™é”çš„ç»„åˆã€‚

åœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼ŒInnoDBåˆ©ç”¨Next-Keyé”é¿å…**å¹»è¯»**çš„äº§ç”Ÿã€‚

## æ’å…¥æ„å‘é”

æ’å…¥æ„å‘é”ç”¨æ¥å¢åŠ å¹¶å‘åº¦ã€‚

æ’å…¥æ„å‘é”æ˜¯ä¸€ç§ç”±`Insert`å‘èµ·çš„é—´éš™é”ã€‚

ä¸åŒäºé—´éš™é”çš„æ’ä»–ï¼Œæ’å…¥æ„å‘é”æ˜¯ä¸€ç§æ„å‘æ’ä»–é”ã€‚

å¯¹äºä¸¤ä¸ªäº‹åŠ¡ï¼Œå¦‚æœæ˜¯å› ä¸º`Insert`å¯¼è‡´éœ€è¦åŠ é—´éš™é”çš„æ—¶å€™ï¼Œä¼šå°è¯•åŠ ä¸€ä¸ªæ’å…¥æ„å‘é”ã€‚

ç›¸è¾ƒäºé—´éš™é”ä¸å…è®¸ä»»ä½•æ’å…¥ï¼Œæ’å…¥æ„å‘é”ä¹‹é—´ï¼Œå…è®¸ä¸åŒä½ç½®çš„æ’å…¥ã€‚

## è‡ªå¢é”

å¯¹äºè‡ªå¢çš„åˆ—ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥å¯¹ä¸¥æ ¼é¡ºåºç”Ÿæˆå’Œå¹¶å‘æ€§èƒ½ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚

# åœºæ™¯è¯•éªŒ

## 0. ç¯å¢ƒ

ä»¥ä¸‹è¯•éªŒå¦‚æ— ç‰¹æ®Šè¯´æ˜ï¼Œå‡åœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œæ•°æ®åº“ç‰ˆæœ¬5.7ã€‚

æœ‰çš„è¯•éªŒä¸å¾—ä¸æ”¹åŠ¨è¡¨ç»“æ„æ‰èƒ½å¾—å‡ºç»“è®ºï¼Œæ‰€ä»¥æœ‰çš„è¯•éªŒæ•°æ®ä¸å¤ªç¬¦åˆã€‚
è¡¨ç»“æ„ï¼š
```mysql
CREATE TABLE `t1` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `val` bigint(20) NOT NULL DEFAULT '0',
  `str` varchar(128) NOT NULL DEFAULT '',
  `no_idx_val` int(11) NOT NULL DEFAULT '0',
  `uni_val` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uni_uni_val` (`uni_val`),
  KEY `idx_val` (`val`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8;
```

## 1. è‡ªå¢ä¸»é”®ï¼Œå¹¶å‘æ’å…¥

ç»“è®ºï¼šä¸ä¼šé˜»å¡ï¼Œå…ˆæ‰§è¡Œçš„è·å¾—è¾ƒå°çš„è‡ªå¢å€¼ã€‚

è¯•éªŒè¿‡ç¨‹ï¼š

1. åˆ†åˆ«å¼€å¯ä¸¤ä¸ªäº‹åŠ¡å…ˆåæ‰§è¡Œ

  ```mysql
  # transactionA
  insert into t1 (val, str, no_idx_val, uni_val) values (8, 'record8', 8, 8);
  # transactionB
  insert into t1 (val, str, no_idx_val, uni_val) values (10, 'record8', 10, 10);
  ```

1. åœ¨æäº¤ä¹‹å‰çš„`show engine innodb status`

  ```
  ------------
  TRANSACTIONS
  ------------
  Trx id counter 2966
  Purge done for trx's n:o < 2963 undo n:o < 0 state: running but idle
  History list length 34
  LIST OF TRANSACTIONS FOR EACH SESSION:
  ---TRANSACTION 422034519421440, not started
  0 lock struct(s), heap size 1136, 0 row lock(s)
  ---TRANSACTION 422034519418704, not started
  0 lock struct(s), heap size 1136, 0 row lock(s)
  ---TRANSACTION 2965, ACTIVE 21 sec
  1 lock struct(s), heap size 1136, 0 row lock(s), undo log entries 1
  MySQL thread id 11, OS thread handle 140559053973248, query id 430 localhost root
  ---TRANSACTION 2963, ACTIVE 94 sec
  1 lock struct(s), heap size 1136, 0 row lock(s), undo log entries 1
  MySQL thread id 4, OS thread handle 140559054243584, query id 425 localhost root
  ```

1. å…ˆæäº¤åå†™å…¥è¯­å¥çš„äº‹åŠ¡ï¼Œå‘ç°è¾ƒå°çš„idç”±å…ˆå†™å…¥å‘½ä»¤çš„äº‹åŠ¡è·å¾—ã€‚
  ```
  +----+--------+----------+------------+---------+
  | id | val    | str      | no_idx_val | uni_val |
  +----+--------+----------+------------+---------+
  ...
  | 10 |      8 | record8  |          8 |       8 |
  | 12 |     10 | record10 |         10 |      10 |
  +----+--------+----------+------------+---------+

  ```

## 2. åœ¨éä¸»é”®ç´¢å¼•ä¸Šè·å–æ’ä»–é”ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

1. éä¸»é”®éå”¯ä¸€ç´¢å¼•ç›¸ç­‰æœç´¢

    ç»“è®ºï¼š

      1. ä¼šä¸ºç¬¦åˆæ¡ä»¶çš„è®°å½•åœ¨ä¸»é”®è®°å½•ä¸Šè¡Œé”æ’ä»–ã€‚
      1. ä¼šä¸ºç¬¦åˆæ¡ä»¶çš„è®°å½•åœ¨å”¯ä¸€ç´¢å¼•è®°å½•ä¸Šè¡Œé”æ’ä»–ã€‚
      1. ä¼šåœ¨è¯¥éå”¯ä¸€ç´¢å¼•ä¸ŠåŠ ä¸€ä¸ªé—´éš™é”ï¼ŒèŒƒå›´æ˜¯è¯¥å€¼çš„å‰åä¸¤ä¸ªå€¼ï¼Œå‡ä¸ºå¼€åŒºé—´ã€‚
          1. å³å‡è®¾æ•°æ®æœ‰333,4444,55555ï¼Œé‚£ä¹ˆé—´éš™é”çš„èŒƒå›´æ˜¯(334,55554)ã€‚
      1. å› ä¸ºçŠ¶æ€å±•ç¤ºæç¤ºæœ‰5ä¸ªè¡Œè¢«é”äº†ï¼Œå¯èƒ½æ˜¯éå”¯ä¸€ç´¢å¼•ä¸Šçš„è¯¥å€¼çš„è®°å½•æœ‰ä¸€ä¸ªæ’ä»–è¡Œé”ã€‚

    æ•°æ®ï¼š

    ```ditaa
    @startuml
    ditaa
    +----+--------+----------+------------+---------+----------------+
    | id | val    | str      | no_idx_val | uni_val | val_with_idx_2 |
    +----+--------+----------+------------+---------+----------------+
    |  1 |    999 | record1  |       1111 |       1 |            999 |
    |  2 | 362324 | record2  |        222 |       2 |         362324 |
    |  3 |   3624 | record3  |          1 |       3 |           3624 |
    |  4 |    324 | record4  |          4 |       4 |            324 |
    |  5 |   9999 | record5  |          1 |       5 |           9999 |
    |  6 |   9999 | record6  |        999 |       6 |           9999 |
    |  7 |    999 | record7  |        998 |       7 |            999 |
    |  9 |      9 | record9  |          9 |       9 |              9 |
    | 10 |      8 | record8  |          8 |       8 |              8 |
    | 12 |     10 | record10 |         10 |      10 |             10 |
    | 14 |     13 | record13 |         13 |      13 |             13 |
    | 15 |     14 | record14 |         14 |      14 |             14 |
    +----+--------+----------+------------+---------+----------------+
    @enduml
    ```

    è¿‡ç¨‹ï¼š
    ```mysql
    # 1. transaction A
    update t1 set val=998 where val=9999;
    # 2 transaction B
    # 2.1 æ•°æ®ä¸Šå’ŒAå®Œå…¨æ— å…³çš„æ•°æ®æˆ–ä¸å­˜åœ¨çš„è®°å½•
    update t1 set val=222 where val=8888; # ä¸ä¼šé˜»å¡ï¼Œå› ä¸º8888ä¸å­˜åœ¨å¯¹åº”çš„è¡Œ
    # 2.2 ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶ä¿®æ”¹
    update t1 set val=222 where val=9999; # é˜»å¡åœ¨idx_valçš„æ’ä»–é”ä¸Š
    # 2.3 å°†å…¶ä»–è®°å½•çš„valä¿®æ”¹æ”¹ä¸º9999/å°äº9999çš„æœ€å¤§val+1 å³3625/å¤§äº9999çš„æœ€å°val-1 å³362323
    update t1 set val=9999 where id=15; 
    # é˜»å¡ï¼Œäº‹åŠ¡Bè¯•å›¾è·å–idx_valä¸Šçš„æ’å…¥æ„å‘é”ï¼Œè¢«ä¸€ä¸ªgapæ’ä»–é”é˜»å¡ã€‚
    # å¾ˆå¥‡æ€ªï¼Œæ˜¯å› ä¸ºRRå—ï¼Ÿå¦‚æœæ˜¯RRé‚£ä¹ˆMVCCåº”è¯¥å°±å¯ä»¥å®ç°äº†ï¼Œæœ‰å¿…è¦åŠ é”å—ï¼Ÿ
    # 2.4 å°è¯•ä¿®æ”¹å¯¹åº”ä¸»é”®çš„è®°å½•çš„å€¼
    update t1 set no_idx_val=5 where id=5; # é˜»å¡åœ¨ä¸»é”®çš„æ’ä»–è¡Œé”ä¸Š
    # 2.5 ä¿®æ”¹ç¬¦åˆè¯¥æ¡ä»¶çš„è®°å½•
    update t1 set no_idx_val = 233 where val=9999; # é˜»å¡åœ¨idx_valä¸Šçš„æ’ä»–è¡Œé”

    ```

1. éä¸»é”®å”¯ä¸€ç´¢å¼•ç›¸ç­‰æœç´¢

todo

1. éä¸»é”®éå”¯ä¸€ç´¢å¼•èŒƒå›´æœç´¢

todo

1. éä¸»é”®å”¯ä¸€ç´¢å¼•èŒƒå›´æœç´¢

todo

## 3. åœ¨æ— ç´¢å¼•åˆ—ä¸Šè¿›è¡ŒèŒƒå›´æŸ¥è¯¢æˆ–æ›´æ–°ã€‚

todo

# å‚è€ƒ

- [MySQLæ‰‹å†Œ-InnoDBé”ä¸äº‹åŠ¡æ¨¡å‹](https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-transaction-model.html)
